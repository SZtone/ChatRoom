<!doctype html>
<html>
<head>
   <meta charset="UTF-8">
   <title>小石头-Chat</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="static/css/new.css">
    <link rel="stylesheet" type="text/css" href="static/css/mui.min.css"/>

    <script  src="static/js/jquery-2.1.4.min.js"></script>
    <script  src="static/js/mui.min.js"></script>
    <script  src="static/js/layer/layer.js"></script>
</head>

<body>

<header class="mui-bar mui-bar-nav">
    <a class="mui-icon mui-icon-bars mui-pull-left"></a>
    <span class="conn"><i class="item-conn">0</i>人在线</span>
    <h1 class="mui-title">二狗子</h1>
</header>
<div class="mui-content" style="padding-bottom: 80px;padding-top: 2.9rem;width: 95%;margin-left: 2.1%;height: 102%;
    position: fixed;    overflow-y: auto;">
        <ul class="ui-content">
            <li class="item">
                <img class="item-toux" src="static/img/portrait.jpg">
                <p class="item-name">小石头</p>
                <div class="item-content">
                    <img src="static/img/portrait.jpg" class="item-content-img">
                    <p class="item-content-text">
                        1,尽快加上发图片功能，<br/>
                        2,聊天记录保存<br/>
                        3,自主设置头像账号及密码<br/>
                        4,群艾特，私聊，加好友等功能
                    </p>
                </div>
            </li>
        </ul>
</div>
<nav class="mui-bar mui-bar-tab" id="nav">
    <div style="background-color: rgba(153, 153, 153, 0.08)">
        <input type="text" class="item-Send-text" name="" value="" style="border-radius: 20px;border: none;" placeholder="我也说一句...">
        <button type="button" class="btn-send">发送</button>
    </div>
</nav>
</body>
</html>
<script>
    $('.mui-pull-left').on('click',function () {
        $('.mui-content').scrollTop( $('.ui-content').height())
        //$('.mui-content').scrollTop( $('.ui-content').height())
        console.log($('.ui-content').height(),$('.ui-content').height());
    })

    var x = 100;
    var y = 1;
    var rand = parseInt(Math.random() * (x - y + 1) + y);
    var name = '路人'+rand;
    var MyTime = new Date();
    var My = Date.parse(MyTime);
    var ws = new WebSocket("ws://106.12.139.157:9090");
    ws.onopen = function(event){
        SendMessg(name, "大家好，我是"+name,My);
        $('.btn-send').on('click',function () {
            const msgs = $('.item-Send-text').val();
            if(msgs == ''){
                layer.msg('请输入内容哦~');return;
            }
            $('.item-Send-text').val('');
            SendMessg(name, msgs,My);
        })
    };


    ws.onmessage= function(event){
        const objs = AsJson(event.data);
        $('.item-conn').text(objs['conns']);
        //const msg = '{"name":"546","msg":"456"}';
        const item_msg = AsJson(objs['msg']);
        ItemLog(item_msg.name,item_msg.msg,item_msg.MyFd);

    }

    ws.onclose = function(event){

        console.log("连接已关闭");
    };



    function AsJson(data){

        var str = JSON.parse(data);
        return str;

    }
    function SendMessg(name,msg,My) {
        ws.send('{"name":"'+name+'","msg":"'+msg+'","MyFd":"'+My+'"}');
    }
    function ItemLog(name,msg,Isme)
    {
        var cname = '';
        if(Isme == My){
            cname = ' me';
        }else{
            cname = 'item'
        }
        //console.log(Isme,My);
        const tags = `<li class="${cname}">
                <img class="item-toux" src="static/img/portrait.jpg">
                <p class="item-name">${name}</p>
                <div class="item-content">
                    <p class="item-content-text">${msg}</p>
                </div>
            </li>`;
        $('.ui-content').append(tags)
        $('.mui-content').scrollTop( $('.ui-content').height())

    }
</script>
