<!doctype html>
<html>
<head>
   <meta charset="UTF-8">
   <title>小石头-Chat</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="static/css/new.css">
    <link rel="stylesheet" href="static/css/side.css">
    <link rel="stylesheet" type="text/css" href="static/css/mui.min.css"/>
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1215947_ifnz632ym5i.css"/>

    <script  src="static/js/jquery-2.1.4.min.js"></script>
    <script  src="static/js/mui.min.js"></script>
    <script  src="static/js/layer/layer.js"></script>
    <style>
        * { touch-action:none; }
        html,
        body {
            background-color: #efeff4;
        }
        span.mui-icon {
            font-size: 14px;
            color: #007aff;
            margin-left: -15px;
            padding-right: 10px;
        }
        .mui-off-canvas-left {
            color: #fff;
        }

    </style>

</head>

<body>

<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable mui-slide-in">
    <aside id="offCanvasSide" class="mui-off-canvas-left">
        <div id="offCanvasSideScroll" class="mui-scroll-wrapper">
            <div class="mui-scroll Side">
                <div class="title">小石头Chat <a id="offCanvasHide" class="mui-icon mui-icon-redo mui-pull-right icon" ></a></div>
                <div class="content">
                    <div class="my-item">
                        <div class="my-item-toux">
                            <img src="static/img/portrait.jpg" alt="">
                            <p>不妄自菲薄，不矫枉过正</p>
                            <p>不随波逐流，不固步自封</p>
                        </div>
                        <div class="my-call">
                            <a class="iconfont icon-qq-line" href=""></a>
                            <a class="iconfont icon-github-fill" href=" "></a>
                            <a class="iconfont icon-git"></a>
                            <a class="iconfont icon-wechat-line"></a>
                            <a class="iconfont icon-icon-test1"></a>
                        </div>
                    </div>
                </div>

                <div class="tone">
                    <p>个人设置</p>
                    <label class="ItemName">
                        名字：
                        <input class="set-item-name" value="路人" placeholder="想个名字吧~" type="text">
                    </label>
                </div>

                <ul class="mui-table-view" style="background: #333;display: none">
                    <li class="mui-table-view-cell mui-collapse mui-active" style="background: #333;">
                        <a class="mui-navigate-right" href="#">在线人员</a>
                        <div class="mui-collapse-content" style="background: #666;color: #333333;">
                            <ul class="mui-table-view" style="display: block;height: 186px;overflow-y: scroll;">
                                <li class="mui-table-view-cell">Item 1</li>
                                <li class="mui-table-view-cell">Item 2</li>
                                <li class="mui-table-view-cell">Item 3</li>
                                <li class="mui-table-view-cell">Item 3</li>
                                <li class="mui-table-view-cell">Item 3</li>
                                <li class="mui-table-view-cell">Item 3</li>
                                <li class="mui-table-view-cell">Item 3</li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    <div class="mui-inner-wrap mui-scroll-wrapper">
        <header class="mui-bar mui-bar-nav">
            <a id='offCanvasShow' class="mui-icon mui-icon-bars mui-pull-left"></a>
            <span class="conn"><i class="item-conn">0</i>人在线</span>
            <h1 class="mui-title">二狗子</h1>
        </header>
        <div class="mui-content" style="padding-bottom: 80px;padding-top: 2.9rem;width: 100%;height: 102%;
            position: fixed;    overflow-y: auto;">
            <ul class="ui-content ">
                <li class="item">
                    <img class="item-toux" src="static/img/portrait.jpg">
                    <p class="item-name">小石头</p>
                    <div class="item-content">
                        <img src="static/img/portrait.jpg" class="item-content-img" />
                        <p class="item-content-text">
                            1,尽快加上发图片功能，<br/>
                            2,聊天记录保存<br/>
                            3,自主设置头像账号及密码<br/>
                            4,群艾特，私聊，加好友等功能
                        </p>
                    </div>
                </li>
            </ul>
        </div>
        <nav class="mui-bar mui-bar-tab" id="nav">
            <div style="background-color: rgba(153, 153, 153, 0.08)">
                <input type="text" class="item-Send-text" name="" value="" style="border-radius: 20px;border: none;" placeholder="我也说一句...">
                <button type="button" class="btn-send">发送</button>
            </div>
        </nav>
    </div>
</div>

</body>
</html>
<script>

    document.addEventListener('touchstart', function(event) {
        // 判断默认行为是否可以被禁用
        if (event.cancelable) {
            // 判断默认行为是否已经被禁用
            if (!event.defaultPrevented) {
                event.preventDefault();
            }
        }
    }, false);
    window.onload = function () {

        mui.init();
//侧滑容器父节点
        var offCanvasWrapper = mui('#offCanvasWrapper');
//主界面容器
        var offCanvasInner = offCanvasWrapper[0].querySelector('.mui-inner-wrap');
//菜单容器
        var offCanvasSide = document.getElementById("offCanvasSide");
        if (!mui.os.android) {
            document.getElementById("move-togger").classList.remove('mui-hidden');
            var spans = document.querySelectorAll('.android-only');
            for (var i = 0, len = spans.length; i < len; i++) {
                spans[i].style.display = "none";
            }
        }
//移动效果是否为整体移动
        var moveTogether = false;
//侧滑容器的class列表，增加.mui-slide-in即可实现菜单移动、主界面不动的效果；
        var classList = offCanvasWrapper[0].classList;
//变换侧滑动画移动效果；
        mui('.mui-input-group').on('change', 'input', function() {
            if (this.checked) {
                offCanvasSide.classList.remove('mui-transitioning');
                offCanvasSide.setAttribute('style', '');
                classList.remove('mui-slide-in');
                classList.remove('mui-scalable');
                switch (this.value) {
                    case 'main-move':
                        if (moveTogether) {
                            //仅主内容滑动时，侧滑菜单在off-canvas-wrap内，和主界面并列
                            offCanvasWrapper[0].insertBefore(offCanvasSide, offCanvasWrapper[0].firstElementChild);
                        }
                        break;
                    case 'main-move-scalable':
                        if (moveTogether) {
                            //仅主内容滑动时，侧滑菜单在off-canvas-wrap内，和主界面并列
                            offCanvasWrapper[0].insertBefore(offCanvasSide, offCanvasWrapper[0].firstElementChild);
                        }
                        classList.add('mui-scalable');
                        break;
                    case 'menu-move':
                        classList.add('mui-slide-in');
                        break;
                    case 'all-move':
                        moveTogether = true;
                        //整体滑动时，侧滑菜单在inner-wrap内
                        offCanvasInner.insertBefore(offCanvasSide, offCanvasInner.firstElementChild);
                        break;
                }
                offCanvasWrapper.offCanvas().refresh();
            }
        });
//主界面‘显示侧滑菜单’按钮的点击事件
        document.getElementById('offCanvasShow').addEventListener('tap', function() {
            offCanvasWrapper.offCanvas('show');
        });
//菜单界面，‘关闭侧滑菜单’按钮的点击事件
        document.getElementById('offCanvasHide').addEventListener('tap', function() {
            offCanvasWrapper.offCanvas('close');
        });
//主界面和侧滑菜单界面均支持区域滚动；
        mui('#offCanvasSideScroll').scroll();
        mui('#offCanvasContentScroll').scroll();
//实现ios平台原生侧滑关闭页面；
        if (mui.os.plus && mui.os.ios) {
            mui.plusReady(function() { //5+ iOS暂时无法屏蔽popGesture时传递touch事件，故该demo直接屏蔽popGesture功能
                plus.webview.currentWebview().setStyle({
                    'popGesture': 'none'
                });
            });
        }
    }

</script>
<script>

    $('.mui-pull-left').on('click',function () {
        $('.mui-content').scrollTop( $('.ui-content').height())
    })

    var x = 100;
    var y = 1;
    var rand = parseInt(Math.random() * (x - y + 1) + y);
    var SetName = $('.set-item-name').val();
    var name = '路人'+rand;
    function SetSendName()
    {
         SetName = $('.set-item-name').val();
        if(SetName != ''){

           name = SetName;
        }
    }
    SetSendName()
    var MyTime = new Date();
    var My = Date.parse(MyTime);
    var ws = new WebSocket("ws://106.12.139.157:9090");
    ws.onopen = function(event){
        SetSendName()
        SendMessg(name, "大家好，我是"+name,My);
        $('.btn-send').on('click',function () {
            const msgs = $('.item-Send-text').val();
            if(msgs == ''){
                layer.msg('请输入内容哦~');return;
            }
            $('.item-Send-text').val('');
            SetSendName()
            SendMessg(name, msgs,My);
        })
    };


    ws.onmessage= function(event){
        const objs = AsJson(event.data);
        $('.item-conn').text(objs['conns']);
        //const msg = '{"name":"546","msg":"456"}';
        const item_msg = AsJson(objs['msg']);
        ItemLog(item_msg.name,item_msg.msg,item_msg.MyFd);

    }

    ws.onclose = function(event){

        console.log("连接已关闭");
    };



    function AsJson(data){

        var str = JSON.parse(data);
        return str;

    }
    function SendMessg(name,msg,My) {
        ws.send('{"name":"'+name+'","msg":"'+msg+'","MyFd":"'+My+'"}');
    }
    function ItemLog(name,msg,Isme)
    {
        var cname = '';
        if(Isme == My){
            cname = ' me';
        }else{
            cname = 'item'
        }
        //console.log(Isme,My);
        const tags = `<li class="${cname}">
                <img class="item-toux" src="static/img/portrait.jpg">
                <p class="item-name">${name}</p>
                <div class="item-content">
                    <p class="item-content-text">${msg}</p>
                </div>
            </li>`;
        $('.ui-content').append(tags)
        $('.mui-content').scrollTop( $('.ui-content').height())

    }

</script>
